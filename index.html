<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω V·∫≠t t∆∞ - Thi·∫øt b·ªã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .status.connected {
            background: rgba(46, 213, 115, 0.3);
        }

        .main-content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #2ed573;
            color: white;
        }

        .btn-success:hover {
            background: #26c764;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-warning {
            background: #ffa502;
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
            animation: slideDown 0.3s;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .chi-tiet-items {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 0;
        }

        .chi-tiet-header {
            display: grid;
            grid-template-columns: 2fr 80px 120px 1fr 1.5fr 1fr auto;
            gap: 10px;
            padding: 12px 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .chi-tiet-header div {
            text-align: center;
        }

        .chi-tiet-item {
            display: grid;
            grid-template-columns: 2fr 80px 120px 1fr 1.5fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        /* Style ri√™ng cho modal s·ª≠a phi·∫øu ƒë·ªÅ ngh·ªã */
        #editPDNChiTiet .chi-tiet-item {
            display: grid;
            grid-template-columns: 2fr 80px 120px 100px 120px 1.5fr 50px;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        #editPDNModal .chi-tiet-header {
            display: grid;
            grid-template-columns: 2fr 80px 120px 100px 120px 1.5fr 50px;
            gap: 10px;
            padding: 12px 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        /* Searchable select styles */
        .searchable-select {
            position: relative;
            width: 100%;
        }
        
        .searchable-select input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .searchable-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 2px solid #667eea;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }
        
        .searchable-select-dropdown.show {
            display: block;
        }
        
        .searchable-select-option {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .searchable-select-option:hover {
            background: #f0f0ff;
        }
        
        .searchable-select-option.selected {
            background: #e8e8ff;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideDown 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #000;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Qu·∫£n l√Ω V·∫≠t t∆∞ - Thi·∫øt b·ªã</h1>
            <p>H·ªá th·ªëng qu·∫£n l√Ω to√†n di·ªán</p>
            <span class="status" id="connectionStatus">‚ö™ ƒêang k·∫øt n·ªëi...</span>
        </div>

        <div class="main-content">
            <div id="alertBox" class="alert"></div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('danh-muc')">üìÅ Danh m·ª•c</button>
                <button class="tab" onclick="switchTab('vat-tu')">üì¶ V·∫≠t t∆∞</button>
                <button class="tab" onclick="switchTab('phieu-de-nghi')">üìù Phi·∫øu ƒë·ªÅ ngh·ªã</button>
                <button class="tab" onclick="switchTab('duyet-de-nghi')">‚úÖ Duy·ªát ƒë·ªÅ ngh·ªã</button>
                <button class="tab" onclick="switchTab('phieu-nhap')">üì• Phi·∫øu nh·∫≠p kho</button>
                <button class="tab" onclick="switchTab('phieu-xuat')">üì§ Phi·∫øu xu·∫•t kho</button>
                <button class="tab" onclick="switchTab('ton-kho')">üìä T·ªìn kho</button>
                <button class="tab" onclick="switchTab('the-kho')">üìã Th·∫ª kho</button>
            </div>

            <!-- Danh m·ª•c Tab -->
            <div id="danh-muc" class="tab-content active">
                <div class="form-section">
                    <h3>‚ûï Th√™m Danh m·ª•c</h3>
                    <form id="categoryForm" onsubmit="createCategory(event)">
                        <div class="form-group">
                            <label>T√™n danh m·ª•c *</label>
                            <input type="text" id="categoryName" required>
                        </div>
                        <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
                    </form>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>ID</th><th>T√™n danh m·ª•c</th></tr>
                        </thead>
                        <tbody id="categoriesTable"><tr><td colspan="2" class="loading">ƒêang t·∫£i...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- V·∫≠t t∆∞ Tab -->
            <div id="vat-tu" class="tab-content">
                <div class="form-section">
                    <h3>‚ûï Th√™m V·∫≠t t∆∞</h3>
                    <form id="itemForm" onsubmit="createItem(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>T√™n v·∫≠t t∆∞ *</label>
                                <input type="text" id="itemName" required>
                            </div>
                            <div class="form-group">
                                <label>ƒê∆°n v·ªã</label>
                                <input type="text" id="itemUnit" placeholder="C√°i, H·ªôp, Kg, L√≠t...">
                            </div>
                            <div class="form-group">
                                <label>Quy c√°ch ƒë√≥ng g√≥i</label>
                                <input type="text" id="itemQuyCach" placeholder="VD: H·ªôp 10, Th√πng 100, L·∫ª">
                            </div>
                            <div class="form-group">
                                <label>H·ªá s·ªë quy ƒë·ªïi</label>
                                <input type="number" id="itemHeSo" value="1" min="0.01" step="0.01" placeholder="VD: H·ªôp 10 = 10">
                            </div>
                            <div class="form-group">
                                <label>Danh m·ª•c</label>
                                <select id="itemCategory"></select>
                            </div>
                            <div class="form-group">
                                <label>T·ªìn t·ªëi thi·ªÉu</label>
                                <input type="number" id="itemMinStock" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>T·ªìn t·ªëi ƒëa</label>
                                <input type="number" id="itemMaxStock" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>ƒê∆°n gi√°</label>
                                <input type="number" id="itemPrice" value="0" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Th√¥ng s·ªë k·ªπ thu·∫≠t</label>
                            <textarea id="itemSpec"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
                    </form>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>M√£ VT</th><th>T√™n</th><th>ƒêVT</th><th>Quy c√°ch</th><th>H·ªá s·ªë</th><th>T·ªìn kho</th><th>Min</th><th>Max</th><th>Gi√°</th><th>Thao t√°c</th></tr>
                        </thead>
                        <tbody id="itemsTable"><tr><td colspan="10" class="loading">ƒêang t·∫£i...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Phi·∫øu ƒë·ªÅ ngh·ªã Tab -->
            <div id="phieu-de-nghi" class="tab-content">
                <div class="form-section">
                    <h3>‚ûï T·∫°o Phi·∫øu ƒë·ªÅ ngh·ªã</h3>
                    <form id="phieuDeNghiForm" onsubmit="createPhieuDeNghi(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Ng∆∞·ªùi ƒë·ªÅ ngh·ªã *</label>
                                <input type="text" id="pdnNguoiDeNghi" required>
                            </div>
                            <div class="form-group">
                                <label>Ph√≤ng ban *</label>
                                <select id="pdnPhongBan" required>
                                    <option value="">-- Ch·ªçn ph√≤ng ban --</option>
                                    <option value="Khoa B·ªánh ngh·ªÅ nghi·ªáp">Khoa B·ªánh ngh·ªÅ nghi·ªáp</option>
                                    <option value="Khoa Dinh d∆∞·ª°ng">Khoa Dinh d∆∞·ª°ng</option>
                                    <option value="Khoa D∆∞·ª£c - V·∫≠t t∆∞ y t·∫ø">Khoa D∆∞·ª£c - V·∫≠t t∆∞ y t·∫ø</option>
                                    <option value="Khoa K√Ω sinh tr√πng C√¥n tr√πng">Khoa K√Ω sinh tr√πng C√¥n tr√πng</option>
                                    <option value="Khoa Ph√≤ng, ch·ªëng b·ªánh truy·ªÅn nhi·ªÖm">Khoa Ph√≤ng, ch·ªëng b·ªánh truy·ªÅn nhi·ªÖm</option>
                                    <option value="Khoa Ph√≤ng, ch·ªëng c√°c b·ªánh kh√¥ng l√¢y nhi·ªÖm">Khoa Ph√≤ng, ch·ªëng c√°c b·ªánh kh√¥ng l√¢y nhi·ªÖm</option>
                                    <option value="Khoa Ph√≤ng, ch·ªëng HIV/AIDS">Khoa Ph√≤ng, ch·ªëng HIV/AIDS</option>
                                    <option value="Khoa S·ª©c kh·ªèe m√¥i tr∆∞·ªùng Y t·∫ø tr∆∞·ªùng h·ªçc">Khoa S·ª©c kh·ªèe m√¥i tr∆∞·ªùng Y t·∫ø tr∆∞·ªùng h·ªçc</option>
                                    <option value="Khoa S·ª©c kh·ªèe sinh s·∫£n">Khoa S·ª©c kh·ªèe sinh s·∫£n</option>
                                    <option value="Khoa Truy·ªÅn th√¥ng, gi√°o d·ª•c s·ª©c kh·ªèe">Khoa Truy·ªÅn th√¥ng, gi√°o d·ª•c s·ª©c kh·ªèe</option>
                                    <option value="Khoa X√©t nghi·ªám Ch·∫©n ƒëo√°n h√¨nh ·∫£nh ThƒÉm d√≤ ch·ª©c nƒÉng">Khoa X√©t nghi·ªám Ch·∫©n ƒëo√°n h√¨nh ·∫£nh ThƒÉm d√≤ ch·ª©c nƒÉng</option>
                                    <option value="Ph√≤ng T·ªï ch·ª©c - H√†nh ch√≠nh">Ph√≤ng T·ªï ch·ª©c - H√†nh ch√≠nh</option>
                                    <option value="Ph√≤ng K·∫ø ho·∫°ch - Nghi·ªáp v·ª•">Ph√≤ng K·∫ø ho·∫°ch - Nghi·ªáp v·ª•</option>
                                    <option value="Ph√≤ng T√†i ch√≠nh - K·∫ø to√°n">Ph√≤ng T√†i ch√≠nh - K·∫ø to√°n</option>
                                    <option value="Ph√≤ng kh√°m ƒëa khoa">Ph√≤ng kh√°m ƒëa khoa</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>L√Ω do *</label>
                            <textarea id="pdnLyDo" required></textarea>
                        </div>
                        
                        <h4>Chi ti·∫øt v·∫≠t t∆∞</h4>
                        <div class="chi-tiet-header">
                            <div>V·∫≠t t∆∞</div>
                            <div>ƒêVT</div>
                            <div>Quy c√°ch</div>
                            <div>S·ªë l∆∞·ª£ng</div>
                            <div>Gi√° d·ª± ki·∫øn</div>
                            <div>Ghi ch√∫</div>
                            <div>X√≥a</div>
                        </div>
                        <div id="pdnChiTiet" class="chi-tiet-items"></div>
                        <button type="button" class="btn btn-primary" onclick="addPDNItem()">‚ûï Th√™m v·∫≠t t∆∞</button>
                        <br><br>
                        <button type="submit" class="btn btn-success">üíæ T·∫°o phi·∫øu</button>
                    </form>
                </div>
                <div class="table-container">
                    <h3>üìã Danh s√°ch Phi·∫øu ƒë·ªÅ ngh·ªã</h3>
                    <table>
                        <thead>
                            <tr><th>M√£ phi·∫øu</th><th>Ng√†y</th><th>Ng∆∞·ªùi ƒë·ªÅ ngh·ªã</th><th>Ph√≤ng ban</th><th>L√Ω do</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr>
                        </thead>
                        <tbody id="phieuDeNghiTable"><tr><td colspan="7" class="loading">ƒêang t·∫£i...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Duy·ªát ƒë·ªÅ ngh·ªã Tab -->
            <div id="duyet-de-nghi" class="tab-content">
                <div class="table-container">
                    <h3>‚úÖ Duy·ªát Phi·∫øu ƒë·ªÅ ngh·ªã</h3>
                    <table>
                        <thead>
                            <tr><th>M√£ phi·∫øu</th><th>Ng√†y</th><th>Ng∆∞·ªùi ƒë·ªÅ ngh·ªã</th><th>Ph√≤ng ban</th><th>L√Ω do</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr>
                        </thead>
                        <tbody id="duyetDeNghiTable"><tr><td colspan="7" class="loading">ƒêang t·∫£i...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Phi·∫øu nh·∫≠p kho Tab -->
            <div id="phieu-nhap" class="tab-content">
                <div class="form-section">
                    <h3>‚ûï T·∫°o Phi·∫øu nh·∫≠p kho</h3>
                    <form id="phieuNhapForm" onsubmit="createPhieuNhap(event)">
                        <div class="form-group">
                            <label>Nh·∫≠p t·ª´ phi·∫øu ƒë·ªÅ ngh·ªã (t√πy ch·ªçn)</label>
                            <select id="pnkFromPDN" onchange="loadPDNToNhap()">
                                <option value="">-- Nh·∫≠p th·ªß c√¥ng --</option>
                            </select>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Ng∆∞·ªùi nh·∫≠p *</label>
                                <input type="text" id="pnkNguoiNhap" required>
                            </div>
                            <div class="form-group">
                                <label>Nh√† cung c·∫•p *</label>
                                <input type="text" id="pnkNhaCungCap" required>
                            </div>
                            <div class="form-group">
                                <label>S·ªë h√≥a ƒë∆°n</label>
                                <input type="text" id="pnkSoHoaDon">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ghi ch√∫</label>
                            <textarea id="pnkGhiChu"></textarea>
                        </div>
                        
                        <h4>Chi ti·∫øt nh·∫≠p</h4>
                        <div class="chi-tiet-header">
                            <div>V·∫≠t t∆∞</div>
                            <div>ƒêVT</div>
                            <div>Quy c√°ch</div>
                            <div>S·ªë l∆∞·ª£ng</div>
                            <div>ƒê∆°n gi√°</div>
                            <div>Ghi ch√∫</div>
                            <div>X√≥a</div>
                        </div>
                        <div id="pnkChiTiet" class="chi-tiet-items"></div>
                        <button type="button" class="btn btn-primary" onclick="addPNKItem()">‚ûï Th√™m v·∫≠t t∆∞</button>
                        <br><br>
                        <button type="submit" class="btn btn-success">üíæ Nh·∫≠p kho</button>
                    </form>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>M√£ phi·∫øu</th><th>Ng√†y nh·∫≠p</th><th>Ng∆∞·ªùi nh·∫≠p</th><th>Nh√† cung c·∫•p</th><th>S·ªë Hƒê</th><th>Thao t√°c</th></tr>
                        </thead>
                        <tbody id="phieuNhapTable"><tr><td colspan="6" class="loading">ƒêang t·∫£i...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Phi·∫øu xu·∫•t kho Tab -->
            <div id="phieu-xuat" class="tab-content">
                <div class="form-section">
                    <h3>‚ûï T·∫°o Phi·∫øu xu·∫•t kho</h3>
                    <form id="phieuXuatForm" onsubmit="createPhieuXuat(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Ng∆∞·ªùi xu·∫•t *</label>
                                <input type="text" id="pxkNguoiXuat" required>
                            </div>
                            <div class="form-group">
                                <label>Ng∆∞·ªùi nh·∫≠n *</label>
                                <input type="text" id="pxkNguoiNhan" required>
                            </div>
                            <div class="form-group">
                                <label>Ph√≤ng ban *</label>
                                <select id="pxkPhongBan" required>
                                    <option value="">-- Ch·ªçn ph√≤ng ban --</option>
                                    <option value="Khoa B·ªánh ngh·ªÅ nghi·ªáp">Khoa B·ªánh ngh·ªÅ nghi·ªáp</option>
                                    <option value="Khoa Dinh d∆∞·ª°ng">Khoa Dinh d∆∞·ª°ng</option>
                                    <option value="Khoa D∆∞·ª£c - V·∫≠t t∆∞ y t·∫ø">Khoa D∆∞·ª£c - V·∫≠t t∆∞ y t·∫ø</option>
                                    <option value="Khoa K√Ω sinh tr√πng C√¥n tr√πng">Khoa K√Ω sinh tr√πng C√¥n tr√πng</option>
                                    <option value="Khoa Ph√≤ng, ch·ªëng b·ªánh truy·ªÅn nhi·ªÖm">Khoa Ph√≤ng, ch·ªëng b·ªánh truy·ªÅn nhi·ªÖm</option>
                                    <option value="Khoa Ph√≤ng, ch·ªëng c√°c b·ªánh kh√¥ng l√¢y nhi·ªÖm">Khoa Ph√≤ng, ch·ªëng c√°c b·ªánh kh√¥ng l√¢y nhi·ªÖm</option>
                                    <option value="Khoa Ph√≤ng, ch·ªëng HIV/AIDS">Khoa Ph√≤ng, ch·ªëng HIV/AIDS</option>
                                    <option value="Khoa S·ª©c kh·ªèe m√¥i tr∆∞·ªùng Y t·∫ø tr∆∞·ªùng h·ªçc">Khoa S·ª©c kh·ªèe m√¥i tr∆∞·ªùng Y t·∫ø tr∆∞·ªùng h·ªçc</option>
                                    <option value="Khoa S·ª©c kh·ªèe sinh s·∫£n">Khoa S·ª©c kh·ªèe sinh s·∫£n</option>
                                    <option value="Khoa Truy·ªÅn th√¥ng, gi√°o d·ª•c s·ª©c kh·ªèe">Khoa Truy·ªÅn th√¥ng, gi√°o d·ª•c s·ª©c kh·ªèe</option>
                                    <option value="Khoa X√©t nghi·ªám Ch·∫©n ƒëo√°n h√¨nh ·∫£nh ThƒÉm d√≤ ch·ª©c nƒÉng">Khoa X√©t nghi·ªám Ch·∫©n ƒëo√°n h√¨nh ·∫£nh ThƒÉm d√≤ ch·ª©c nƒÉng</option>
                                    <option value="Ph√≤ng T·ªï ch·ª©c - H√†nh ch√≠nh">Ph√≤ng T·ªï ch·ª©c - H√†nh ch√≠nh</option>
                                    <option value="Ph√≤ng K·∫ø ho·∫°ch - Nghi·ªáp v·ª•">Ph√≤ng K·∫ø ho·∫°ch - Nghi·ªáp v·ª•</option>
                                    <option value="Ph√≤ng T√†i ch√≠nh - K·∫ø to√°n">Ph√≤ng T√†i ch√≠nh - K·∫ø to√°n</option>
                                    <option value="Ph√≤ng kh√°m ƒëa khoa">Ph√≤ng kh√°m ƒëa khoa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Lo·∫°i xu·∫•t *</label>
                                <select id="pxkLoaiXuat" required>
                                    <option value="S·ª≠ d·ª•ng">S·ª≠ d·ª•ng</option>
                                    <option value="H·ªßy">H·ªßy</option>
                                    <option value="Kh√°c">Kh√°c</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>L√Ω do *</label>
                            <textarea id="pxkLyDo" required></textarea>
                        </div>
                        
                        <h4>Chi ti·∫øt xu·∫•t</h4>
                        <div class="chi-tiet-header">
                            <div>V·∫≠t t∆∞</div>
                            <div>ƒêVT</div>
                            <div>Quy c√°ch</div>
                            <div>S·ªë l∆∞·ª£ng</div>
                            <div>ƒê∆°n gi√°</div>
                            <div>Ghi ch√∫</div>
                            <div>X√≥a</div>
                        </div>
                        <div id="pxkChiTiet" class="chi-tiet-items"></div>
                        <button type="button" class="btn btn-primary" onclick="addPXKItem()">‚ûï Th√™m v·∫≠t t∆∞</button>
                        <br><br>
                        <button type="submit" class="btn btn-success">üíæ Xu·∫•t kho</button>
                    </form>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>M√£ phi·∫øu</th><th>Ng√†y xu·∫•t</th><th>Ng∆∞·ªùi xu·∫•t</th><th>Ng∆∞·ªùi nh·∫≠n</th><th>Lo·∫°i xu·∫•t</th><th>Thao t√°c</th></tr>
                        </thead>
                        <tbody id="phieuXuatTable"><tr><td colspan="6" class="loading">ƒêang t·∫£i...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- T·ªìn kho Tab -->
            <div id="ton-kho" class="tab-content">
                <h3>üìä B√°o c√°o t·ªìn kho</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>M√£ VT</th><th>T√™n</th><th>ƒêVT</th><th>T·ªìn kho</th><th>Min</th><th>Max</th><th>Tr·∫°ng th√°i</th></tr>
                        </thead>
                        <tbody id="tonKhoTable"><tr><td colspan="7" class="loading">ƒêang t·∫£i...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Th·∫ª kho Tab -->
            <div id="the-kho" class="tab-content">
                <div class="form-section">
                    <h3>üîç Xem Th·∫ª kho</h3>
                    <div class="form-group">
                        <label>Ch·ªçn v·∫≠t t∆∞</label>
                        <select id="theKhoItemSelect" onchange="loadTheKho()">
                            <option value="">-- Ch·ªçn v·∫≠t t∆∞ --</option>
                        </select>
                    </div>
                </div>
                <div id="theKhoContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal s·ª≠a v·∫≠t t∆∞ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è S·ª≠a V·∫≠t t∆∞</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editItemForm" onsubmit="updateItem(event)">
                <input type="hidden" id="editItemId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>M√£ v·∫≠t t∆∞</label>
                        <input type="text" id="editItemCode" disabled style="background: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label>T√™n v·∫≠t t∆∞ *</label>
                        <input type="text" id="editItemName" required>
                    </div>
                    <div class="form-group">
                        <label>ƒê∆°n v·ªã</label>
                        <input type="text" id="editItemUnit">
                    </div>
                    <div class="form-group">
                        <label>Quy c√°ch ƒë√≥ng g√≥i</label>
                        <input type="text" id="editItemQuyCach">
                    </div>
                    <div class="form-group">
                        <label>H·ªá s·ªë quy ƒë·ªïi</label>
                        <input type="number" id="editItemHeSo" min="0.01" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Danh m·ª•c</label>
                        <select id="editItemCategory"></select>
                    </div>
                    <div class="form-group">
                        <label>T·ªìn t·ªëi thi·ªÉu</label>
                        <input type="number" id="editItemMinStock" min="0">
                    </div>
                    <div class="form-group">
                        <label>T·ªìn t·ªëi ƒëa</label>
                        <input type="number" id="editItemMaxStock" min="0">
                    </div>
                    <div class="form-group">
                        <label>ƒê∆°n gi√° (gi√° mua g·∫ßn nh·∫•t)</label>
                        <input type="number" id="editItemPrice" readonly style="background: #f0f0f0; cursor: not-allowed;" title="Gi√° t·ª± ƒë·ªông l·∫•y t·ª´ phi·∫øu nh·∫≠p kho g·∫ßn nh·∫•t">
                    </div>
                    <div class="form-group">
                        <label>T·ªìn kho hi·ªán t·∫°i</label>
                        <input type="number" id="editItemStock" disabled style="background: #f0f0f0;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Th√¥ng s·ªë k·ªπ thu·∫≠t</label>
                    <textarea id="editItemSpec"></textarea>
                </div>
                <button type="submit" class="btn btn-success">üíæ C·∫≠p nh·∫≠t</button>
                <button type="button" class="btn btn-danger" onclick="closeEditModal()">‚ùå H·ªßy</button>
            </form>
        </div>
    </div>

    <!-- Modal xem chi ti·∫øt phi·∫øu ƒë·ªÅ ngh·ªã -->
    <div id="pdnModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>üìã Chi ti·∫øt Phi·∫øu ƒë·ªÅ ngh·ªã</h3>
                <span class="close" onclick="closePDNModal()">&times;</span>
            </div>
            <div id="pdnModalBody" style="padding: 20px;">
                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label><strong>M√£ phi·∫øu:</strong></label>
                        <p id="pdnMaPhieu" style="color: #667eea; font-weight: bold; font-size: 1.1em;"></p>
                    </div>
                    <div class="form-group">
                        <label><strong>Ng√†y ƒë·ªÅ ngh·ªã:</strong></label>
                        <p id="pdnNgay"></p>
                    </div>
                    <div class="form-group">
                        <label><strong>Ng∆∞·ªùi ƒë·ªÅ ngh·ªã:</strong></label>
                        <p id="pdnNguoi"></p>
                    </div>
                    <div class="form-group">
                        <label><strong>Ph√≤ng ban:</strong></label>
                        <p id="pdnPhongBan"></p>
                    </div>
                    <div class="form-group">
                        <label><strong>Tr·∫°ng th√°i:</strong></label>
                        <p id="pdnTrangThai"></p>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label><strong>L√Ω do:</strong></label>
                    <p id="pdnLyDo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; white-space: pre-wrap;"></p>
                </div>
                <div class="form-group">
                    <label><strong>Chi ti·∫øt v·∫≠t t∆∞:</strong></label>
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>M√£ VT</th>
                                    <th>T√™n v·∫≠t t∆∞</th>
                                    <th>ƒêVT</th>
                                    <th>Quy c√°ch</th>
                                    <th>S·ªë l∆∞·ª£ng</th>
                                    <th>Gi√° d·ª± ki·∫øn</th>
                                    <th>Th√†nh ti·ªÅn</th>
                                    <th>Ghi ch√∫</th>
                                </tr>
                            </thead>
                            <tbody id="pdnChiTietTable"></tbody>
                        </table>
                    </div>
                    <div style="text-align: right; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <strong style="font-size: 1.2em; color: #667eea;">T·ªïng ti·ªÅn d·ª± ki·∫øn: <span id="pdnTongTien"></span></strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal s·ª≠a phi·∫øu ƒë·ªÅ ngh·ªã -->
    <div id="editPDNModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>‚úèÔ∏è S·ª≠a Phi·∫øu ƒë·ªÅ ngh·ªã</h3>
                <span class="close" onclick="closeEditPDNModal()">&times;</span>
            </div>
            <form id="editPDNForm" onsubmit="updatePhieuDeNghi(event)">
                <input type="hidden" id="editPDNId">
                <div class="form-grid" style="padding: 20px;">
                    <div class="form-group">
                        <label>M√£ phi·∫øu</label>
                        <input type="text" id="editPDNMaPhieu" disabled style="background: #f0f0f0; font-weight: bold; color: #667eea;">
                    </div>
                    <div class="form-group">
                        <label>Ng∆∞·ªùi ƒë·ªÅ ngh·ªã *</label>
                        <input type="text" id="editPDNNguoi" required>
                    </div>
                    <div class="form-group">
                        <label>Ph√≤ng ban *</label>
                        <select id="editPDNPhongBan" required>
                            <option value="">-- Ch·ªçn ph√≤ng ban --</option>
                            <option value="Khoa B·ªánh ngh·ªÅ nghi·ªáp">Khoa B·ªánh ngh·ªÅ nghi·ªáp</option>
                            <option value="Khoa Dinh d∆∞·ª°ng">Khoa Dinh d∆∞·ª°ng</option>
                            <option value="Khoa D∆∞·ª£c - V·∫≠t t∆∞ y t·∫ø">Khoa D∆∞·ª£c - V·∫≠t t∆∞ y t·∫ø</option>
                            <option value="Khoa K√Ω sinh tr√πng C√¥n tr√πng">Khoa K√Ω sinh tr√πng C√¥n tr√πng</option>
                            <option value="Khoa Ph√≤ng, ch·ªëng b·ªánh truy·ªÅn nhi·ªÖm">Khoa Ph√≤ng, ch·ªëng b·ªánh truy·ªÅn nhi·ªÖm</option>
                            <option value="Khoa Ph√≤ng, ch·ªëng c√°c b·ªánh kh√¥ng l√¢y nhi·ªÖm">Khoa Ph√≤ng, ch·ªëng c√°c b·ªánh kh√¥ng l√¢y nhi·ªÖm</option>
                            <option value="Khoa Ph√≤ng, ch·ªëng HIV/AIDS">Khoa Ph√≤ng, ch·ªëng HIV/AIDS</option>
                            <option value="Khoa S·ª©c kh·ªèe m√¥i tr∆∞·ªùng Y t·∫ø tr∆∞·ªùng h·ªçc">Khoa S·ª©c kh·ªèe m√¥i tr∆∞·ªùng Y t·∫ø tr∆∞·ªùng h·ªçc</option>
                            <option value="Khoa S·ª©c kh·ªèe sinh s·∫£n">Khoa S·ª©c kh·ªèe sinh s·∫£n</option>
                            <option value="Khoa Truy·ªÅn th√¥ng, gi√°o d·ª•c s·ª©c kh·ªèe">Khoa Truy·ªÅn th√¥ng, gi√°o d·ª•c s·ª©c kh·ªèe</option>
                            <option value="Khoa X√©t nghi·ªám Ch·∫©n ƒëo√°n h√¨nh ·∫£nh ThƒÉm d√≤ ch·ª©c nƒÉng">Khoa X√©t nghi·ªám Ch·∫©n ƒëo√°n h√¨nh ·∫£nh ThƒÉm d√≤ ch·ª©c nƒÉng</option>
                            <option value="Ph√≤ng T·ªï ch·ª©c - H√†nh ch√≠nh">Ph√≤ng T·ªï ch·ª©c - H√†nh ch√≠nh</option>
                            <option value="Ph√≤ng K·∫ø ho·∫°ch - Nghi·ªáp v·ª•">Ph√≤ng K·∫ø ho·∫°ch - Nghi·ªáp v·ª•</option>
                            <option value="Ph√≤ng T√†i ch√≠nh - K·∫ø to√°n">Ph√≤ng T√†i ch√≠nh - K·∫ø to√°n</option>
                            <option value="Ph√≤ng kh√°m ƒëa khoa">Ph√≤ng kh√°m ƒëa khoa</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="padding: 0 20px;">
                    <label>L√Ω do *</label>
                    <textarea id="editPDNLyDo" required rows="3"></textarea>
                </div>
                
                <div style="padding: 20px;">
                    <h4>Chi ti·∫øt v·∫≠t t∆∞</h4>
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>V·∫≠t t∆∞</th>
                                    <th>ƒêVT</th>
                                    <th>Quy c√°ch</th>
                                    <th>S·ªë l∆∞·ª£ng</th>
                                    <th>Gi√° d·ª± ki·∫øn</th>
                                    <th>Ghi ch√∫</th>
                                    <th>X√≥a</th>
                                </tr>
                            </thead>
                            <tbody id="editPDNChiTiet"></tbody>
                        </table>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addEditPDNItem()" style="margin-top: 10px;">‚ûï Th√™m v·∫≠t t∆∞</button>
                </div>
                
                <div style="padding: 0 20px 20px 20px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditPDNModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-success">üíæ L∆∞u thay ƒë·ªïi</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // T·ª± ƒë·ªông ph√°t hi·ªán API URL
        // N·∫øu m·ªü t·ª´ file://, fallback v·ªÅ localhost
        const API_URL = window.location.origin.startsWith('file://') 
            ? 'http://localhost:8000' 
            : window.location.origin;
        console.log('API_URL:', API_URL); // Debug log
        let allItems = [];
        let allCategories = [];

        // Check connection
        async function checkConnection() {
            try {
                console.log('Checking connection to:', `${API_URL}/`);
                const response = await fetch(`${API_URL}/categories`);
                console.log('Connection response:', response.status);
                if (response.ok) {
                    document.getElementById('connectionStatus').innerHTML = 'üü¢ ƒê√£ k·∫øt n·ªëi';
                    document.getElementById('connectionStatus').className = 'status connected';
                    return true;
                }
            } catch (error) {
                console.error('Connection error:', error);
                document.getElementById('connectionStatus').innerHTML = 'üî¥ M·∫•t k·∫øt n·ªëi';
                return false;
            }
        }

        // Show alert
        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            setTimeout(() => alertBox.classList.remove('show'), 4000);
        }

        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'danh-muc') loadCategories();
            if (tabName === 'vat-tu') { loadCategories(); loadItems(); }
            if (tabName === 'phieu-de-nghi') { loadItems(); loadPhieuDeNghi(); }
            if (tabName === 'duyet-de-nghi') { loadDuyetDeNghi(); }
            if (tabName === 'phieu-nhap') { loadItems(); loadPhieuNhap(); loadApprovedPDN(); }
            if (tabName === 'phieu-xuat') { loadItems(); loadPhieuXuat(); }
            if (tabName === 'ton-kho') loadTonKho();
            if (tabName === 'the-kho') { loadItems(); populateTheKhoSelect(); }
        }

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/categories`);
                allCategories = await response.json();
                
                document.getElementById('categoriesTable').innerHTML = allCategories.map(cat => 
                    `<tr><td>${cat.id}</td><td>${cat.name}</td></tr>`
                ).join('') || '<tr><td colspan="2">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';

                // Update select
                const selects = ['itemCategory'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>' +
                            allCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
                    }
                });
            } catch (error) {
                showAlert('L·ªói khi t·∫£i danh m·ª•c!', 'error');
            }
        }

        // Create category
        async function createCategory(e) {
            e.preventDefault();
            try {
                const response = await fetch(`${API_URL}/categories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: document.getElementById('categoryName').value })
                });
                if (response.ok) {
                    showAlert('‚úÖ Th√™m danh m·ª•c th√†nh c√¥ng!');
                    document.getElementById('categoryForm').reset();
                    loadCategories();
                } else {
                    const error = await response.json();
                    showAlert(`‚ùå ${error.detail}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå L·ªói khi th√™m danh m·ª•c!', 'error');
            }
        }

        // Load items
        async function loadItems() {
            try {
                console.log('Loading items from:', `${API_URL}/items`);
                const response = await fetch(`${API_URL}/items`);
                console.log('Items response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allItems = await response.json();
                console.log('Items loaded:', allItems.length);
                
                document.getElementById('itemsTable').innerHTML = allItems.map(item => 
                    `<tr>
                        <td><strong>${item.code}</strong></td>
                        <td>${item.name}</td>
                        <td>${item.unit || '-'}</td>
                        <td>${item.quy_cach || '-'}</td>
                        <td>${item.he_so_quy_doi}</td>
                        <td><strong>${item.current_stock}</strong></td>
                        <td>${item.min_stock}</td>
                        <td>${item.max_stock}</td>
                        <td>${item.price.toLocaleString()}</td>
                        <td><button class="btn btn-primary btn-small" onclick="openEditModal(${item.id})">‚úèÔ∏è S·ª≠a</button></td>
                    </tr>`
                ).join('') || '<tr><td colspan="10">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            } catch (error) {
                console.error('Error loading items:', error);
                showAlert('L·ªói khi t·∫£i v·∫≠t t∆∞: ' + error.message, 'error');
            }
        }

        // Create item
        async function createItem(e) {
            e.preventDefault();
            const itemData = {
                name: document.getElementById('itemName').value,
                unit: document.getElementById('itemUnit').value || null,
                spec: document.getElementById('itemSpec').value || null,
                quy_cach: document.getElementById('itemQuyCach').value || null,
                he_so_quy_doi: parseFloat(document.getElementById('itemHeSo').value) || 1,
                min_stock: parseInt(document.getElementById('itemMinStock').value) || 0,
                max_stock: parseInt(document.getElementById('itemMaxStock').value) || 0,
                price: parseFloat(document.getElementById('itemPrice').value) || 0,
                category_id: document.getElementById('itemCategory').value ? parseInt(document.getElementById('itemCategory').value) : null
            };

            try {
                const response = await fetch(`${API_URL}/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });
                if (response.ok) {
                    const result = await response.json();
                    showAlert(`‚úÖ Th√™m v·∫≠t t∆∞ ${result.code} th√†nh c√¥ng!`);
                    document.getElementById('itemForm').reset();
                    loadItems();
                } else {
                    const error = await response.json();
                    showAlert(`‚ùå ${error.detail}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå L·ªói khi th√™m v·∫≠t t∆∞!', 'error');
            }
        }

        // Edit item functions
        async function openEditModal(itemId) {
            try {
                const response = await fetch(`${API_URL}/items/${itemId}`);
                const item = await response.json();
                
                document.getElementById('editItemId').value = item.id;
                document.getElementById('editItemCode').value = item.code;
                document.getElementById('editItemName').value = item.name;
                document.getElementById('editItemUnit').value = item.unit || '';
                document.getElementById('editItemQuyCach').value = item.quy_cach || '';
                document.getElementById('editItemHeSo').value = item.he_so_quy_doi;
                document.getElementById('editItemMinStock').value = item.min_stock;
                document.getElementById('editItemMaxStock').value = item.max_stock;
                document.getElementById('editItemPrice').value = item.price;
                document.getElementById('editItemStock').value = item.current_stock;
                document.getElementById('editItemSpec').value = item.spec || '';
                
                // Load categories for select
                document.getElementById('editItemCategory').innerHTML = 
                    '<option value="">-- Ch·ªçn danh m·ª•c --</option>' +
                    allCategories.map(cat => 
                        `<option value="${cat.id}" ${cat.id === item.category_id ? 'selected' : ''}>${cat.name}</option>`
                    ).join('');
                
                document.getElementById('editModal').style.display = 'block';
            } catch (error) {
                showAlert('L·ªói khi t·∫£i th√¥ng tin v·∫≠t t∆∞!', 'error');
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        async function updateItem(e) {
            e.preventDefault();
            const itemId = document.getElementById('editItemId').value;
            const itemData = {
                name: document.getElementById('editItemName').value,
                unit: document.getElementById('editItemUnit').value || null,
                spec: document.getElementById('editItemSpec').value || null,
                quy_cach: document.getElementById('editItemQuyCach').value || null,
                he_so_quy_doi: parseFloat(document.getElementById('editItemHeSo').value) || 1,
                min_stock: parseInt(document.getElementById('editItemMinStock').value) || 0,
                max_stock: parseInt(document.getElementById('editItemMaxStock').value) || 0,
                // Kh√¥ng c·∫≠p nh·∫≠t gi√° - gi√° l·∫•y t·ª´ phi·∫øu nh·∫≠p g·∫ßn nh·∫•t
                category_id: document.getElementById('editItemCategory').value ? 
                    parseInt(document.getElementById('editItemCategory').value) : null
            };

            try {
                const response = await fetch(`${API_URL}/items/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });
                if (response.ok) {
                    showAlert('‚úÖ C·∫≠p nh·∫≠t v·∫≠t t∆∞ th√†nh c√¥ng!');
                    closeEditModal();
                    loadItems();
                } else {
                    const error = await response.json();
                    showAlert(`‚ùå ${error.detail}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå L·ªói khi c·∫≠p nh·∫≠t v·∫≠t t∆∞!', 'error');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        }

        // Phi·∫øu ƒë·ªÅ ngh·ªã functions
        let pdnCounter = 0;
        function addPDNItem() {
            const div = document.createElement('div');
            div.className = 'chi-tiet-item';
            div.id = `pdn-item-${pdnCounter}`;
            div.innerHTML = `
                <select class="pdn-item" required onchange="updatePDNItemInfo(${pdnCounter})">
                    <option value="">-- Ch·ªçn v·∫≠t t∆∞ --</option>
                    ${allItems.map(item => `<option value="${item.id}" data-unit="${item.unit || ''}" data-quycach="${item.quy_cach || ''}" data-price="${item.price}">${item.name}</option>`).join('')}
                </select>
                <input type="text" class="pdn-unit" placeholder="ƒêVT" readonly style="background: #f0f0f0; width: 80px;">
                <input type="text" class="pdn-quycach" placeholder="Quy c√°ch" readonly style="background: #f0f0f0; width: 120px;">
                <input type="number" class="pdn-soluong" placeholder="S·ªë l∆∞·ª£ng" required min="1">
                <input type="number" class="pdn-dongia" placeholder="Gi√° d·ª± ki·∫øn (kh√¥ng b·∫Øt bu·ªôc)" min="0" step="0.01">
                <input type="text" class="pdn-ghichu" placeholder="Ghi ch√∫">
                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            document.getElementById('pdnChiTiet').appendChild(div);
            pdnCounter++;
        }

        function updatePDNItemInfo(index) {
            const container = document.getElementById(`pdn-item-${index}`);
            if (!container) return;
            
            const select = container.querySelector('.pdn-item');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const unit = selectedOption.getAttribute('data-unit') || '-';
                const quycach = selectedOption.getAttribute('data-quycach') || '-';
                const price = selectedOption.getAttribute('data-price') || '0';
                
                container.querySelector('.pdn-unit').value = unit;
                container.querySelector('.pdn-quycach').value = quycach;
                container.querySelector('.pdn-dongia').value = price;
            } else {
                container.querySelector('.pdn-unit').value = '';
                container.querySelector('.pdn-quycach').value = '';
                container.querySelector('.pdn-dongia').value = '';
            }
        }

        async function createPhieuDeNghi(e) {
            e.preventDefault();
            const chiTiet = [];
            document.querySelectorAll('#pdnChiTiet .chi-tiet-item').forEach(item => {
                const donGia = parseFloat(item.querySelector('.pdn-dongia').value);
                chiTiet.push({
                    item_id: parseInt(item.querySelector('.pdn-item').value),
                    so_luong: parseInt(item.querySelector('.pdn-soluong').value),
                    don_gia_du_kien: donGia > 0 ? donGia : 0,
                    ghi_chu: item.querySelector('.pdn-ghichu').value || null
                });
            });

            if (chiTiet.length === 0) {
                showAlert('‚ùå Vui l√≤ng th√™m √≠t nh·∫•t 1 v·∫≠t t∆∞!', 'error');
                return;
            }

            const data = {
                nguoi_de_nghi: document.getElementById('pdnNguoiDeNghi').value,
                phong_ban: document.getElementById('pdnPhongBan').value,
                ly_do: document.getElementById('pdnLyDo').value,
                chi_tiet: chiTiet
            };

            try {
                const response = await fetch(`${API_URL}/phieu-de-nghi`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    const result = await response.json();
                    showAlert(`‚úÖ T·∫°o phi·∫øu ${result.ma_phieu} th√†nh c√¥ng!`);
                    document.getElementById('phieuDeNghiForm').reset();
                    document.getElementById('pdnChiTiet').innerHTML = '';
                    pdnCounter = 0;
                    loadPhieuDeNghi();
                } else {
                    showAlert('‚ùå L·ªói khi t·∫°o phi·∫øu!', 'error');
                }
            } catch (error) {
                showAlert('‚ùå L·ªói khi t·∫°o phi·∫øu!', 'error');
            }
        }

        async function loadPhieuDeNghi() {
            try {
                const response = await fetch(`${API_URL}/phieu-de-nghi`);
                const phieus = await response.json();
                
                document.getElementById('phieuDeNghiTable').innerHTML = phieus.map(p => {
                    let badgeClass = p.trang_thai === 'ƒê√£ duy·ªát' ? 'badge-success' : 
                                     p.trang_thai === 'T·ª´ ch·ªëi' ? 'badge-danger' : 'badge-warning';
                    const date = new Date(p.ngay_de_nghi);
                    const formattedDate = date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
                    const lyDoShort = p.ly_do.length > 50 ? p.ly_do.substring(0, 50) + '...' : p.ly_do;
                    
                    return `<tr>
                        <td><strong>${p.ma_phieu}</strong></td>
                        <td>${formattedDate}</td>
                        <td>${p.nguoi_de_nghi}</td>
                        <td>${p.phong_ban}</td>
                        <td title="${p.ly_do}">${lyDoShort}</td>
                        <td><span class="badge ${badgeClass}">${p.trang_thai}</span></td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-primary btn-small" onclick="xemChiTietPDN(${p.id})" title="Xem chi ti·∫øt">üëÅÔ∏è</button>
                            ${p.trang_thai === 'Ch·ªù duy·ªát' ? 
                                `<button class="btn btn-info btn-small" onclick="suaPhieuDeNghi(${p.id})" title="S·ª≠a phi·∫øu">‚úèÔ∏è</button>
                                 <button class="btn btn-success btn-small" onclick="pheDuyetPhieu(${p.id}, 'ƒê√£ duy·ªát')" title="Duy·ªát phi·∫øu">‚úÖ</button>
                                 <button class="btn btn-danger btn-small" onclick="pheDuyetPhieu(${p.id}, 'T·ª´ ch·ªëi')" title="T·ª´ ch·ªëi">‚ùå</button>` 
                                : `<button class="btn btn-info btn-small" onclick="suaPhieuDeNghi(${p.id})" title="S·ª≠a phi·∫øu">‚úèÔ∏è</button>`}
                            <button class="btn btn-danger btn-small" onclick="deletePhieuDeNghi(${p.id}, '${p.ma_phieu}')" title="X√≥a phi·∫øu">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                }).join('') || '<tr><td colspan="7">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            } catch (error) {
                showAlert('L·ªói khi t·∫£i phi·∫øu ƒë·ªÅ ngh·ªã!', 'error');
            }
        }

        async function deletePhieuDeNghi(id, maPhieu) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phi·∫øu ${maPhieu}?\n\nL∆∞u √Ω: H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/phieu-de-nghi/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('ƒê√£ x√≥a phi·∫øu ƒë·ªÅ ngh·ªã th√†nh c√¥ng!', 'success');
                    loadPhieuDeNghi();
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'L·ªói khi x√≥a phi·∫øu ƒë·ªÅ ngh·ªã!', 'error');
                }
            } catch (error) {
                showAlert('L·ªói k·∫øt n·ªëi khi x√≥a phi·∫øu ƒë·ªÅ ngh·ªã!', 'error');
            }
        }

        // Phi·∫øu nh·∫≠p kho functions
        let pnkCounter = 0;
        function addPNKItem() {
            const div = document.createElement('div');
            div.className = 'chi-tiet-item';
            div.id = `pnk-item-${pnkCounter}`;
            div.innerHTML = `
                <select class="pnk-item" required onchange="updatePNKItemInfo(${pnkCounter})">
                    <option value="">-- Ch·ªçn v·∫≠t t∆∞ --</option>
                    ${allItems.map(item => `<option value="${item.id}" data-unit="${item.unit || ''}" data-quycach="${item.quy_cach || ''}" data-price="${item.price}">${item.name}</option>`).join('')}
                </select>
                <input type="text" class="pnk-unit" placeholder="ƒêVT" readonly style="background: #f0f0f0; width: 80px;">
                <input type="text" class="pnk-quycach" placeholder="Quy c√°ch" readonly style="background: #f0f0f0; width: 120px;">
                <input type="number" class="pnk-soluong" placeholder="S·ªë l∆∞·ª£ng" required min="1">
                <input type="number" class="pnk-dongia" placeholder="ƒê∆°n gi√°" required min="0" step="0.01">
                <input type="text" class="pnk-ghichu" placeholder="Ghi ch√∫">
                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            document.getElementById('pnkChiTiet').appendChild(div);
            pnkCounter++;
        }

        function updatePNKItemInfo(index) {
            const container = document.getElementById(`pnk-item-${index}`);
            if (!container) return;
            
            const select = container.querySelector('.pnk-item');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const unit = selectedOption.getAttribute('data-unit') || '-';
                const quycach = selectedOption.getAttribute('data-quycach') || '-';
                const price = selectedOption.getAttribute('data-price') || '0';
                
                container.querySelector('.pnk-unit').value = unit;
                container.querySelector('.pnk-quycach').value = quycach;
                container.querySelector('.pnk-dongia').value = price;
            } else {
                container.querySelector('.pnk-unit').value = '';
                container.querySelector('.pnk-quycach').value = '';
                container.querySelector('.pnk-dongia').value = '';
            }
        }

        async function loadPDNToNhap() {
            const pdnId = document.getElementById('pnkFromPDN').value;
            if (!pdnId) {
                document.getElementById('pnkChiTiet').innerHTML = '';
                pnkCounter = 0;
                return;
            }

            try {
                const response = await fetch(`${API_URL}/phieu-de-nghi/${pdnId}`);
                if (response.ok) {
                    const phieu = await response.json();
                    document.getElementById('pnkChiTiet').innerHTML = '';
                    pnkCounter = 0;
                    
                    for (const ct of phieu.chi_tiet) {
                        const div = document.createElement('div');
                        div.className = 'chi-tiet-item';
                        div.id = `pnk-item-${pnkCounter}`;
                        
                        const item = allItems.find(i => i.id === ct.item_id);
                        div.innerHTML = `
                            <select class="pnk-item" required onchange="updatePNKItemInfo(${pnkCounter})">
                                ${allItems.map(i => `<option value="${i.id}" ${i.id === ct.item_id ? 'selected' : ''} data-unit="${i.unit || ''}" data-quycach="${i.quy_cach || ''}" data-price="${i.price}">${i.code} - ${i.name}</option>`).join('')}
                            </select>
                            <input type="text" class="pnk-unit" value="${item?.unit || '-'}" readonly style="background: #f0f0f0; width: 80px;">
                            <input type="text" class="pnk-quycach" value="${item?.quy_cach || '-'}" readonly style="background: #f0f0f0; width: 120px;">
                            <input type="number" class="pnk-soluong" value="${ct.so_luong}" required min="1">
                            <input type="number" class="pnk-dongia" value="${ct.don_gia_du_kien || item?.price || 0}" required min="0" step="0.01">
                            <input type="text" class="pnk-ghichu" value="${ct.ghi_chu || ''}" placeholder="Ghi ch√∫">
                            <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                        `;
                        document.getElementById('pnkChiTiet').appendChild(div);
                        pnkCounter++;
                    }
                }
            } catch (error) {
                showAlert('‚ùå L·ªói khi t·∫£i phi·∫øu ƒë·ªÅ ngh·ªã!', 'error');
            }
        }

        async function createPhieuNhap(e) {
            e.preventDefault();
            const chiTiet = [];
            document.querySelectorAll('#pnkChiTiet .chi-tiet-item').forEach(item => {
                chiTiet.push({
                    item_id: parseInt(item.querySelector('.pnk-item').value),
                    so_luong: parseInt(item.querySelector('.pnk-soluong').value),
                    don_gia: parseFloat(item.querySelector('.pnk-dongia').value),
                    ghi_chu: item.querySelector('.pnk-ghichu').value || null
                });
            });

            if (chiTiet.length === 0) {
                showAlert('‚ùå Vui l√≤ng th√™m √≠t nh·∫•t 1 v·∫≠t t∆∞!', 'error');
                return;
            }

            const data = {
                nguoi_nhap: document.getElementById('pnkNguoiNhap').value,
                nha_cung_cap: document.getElementById('pnkNhaCungCap').value,
                so_hoa_don: document.getElementById('pnkSoHoaDon').value || null,
                ghi_chu: document.getElementById('pnkGhiChu').value || null,
                chi_tiet: chiTiet
            };

            try {
                const response = await fetch(`${API_URL}/phieu-nhap-kho`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    const result = await response.json();
                    showAlert(`‚úÖ Nh·∫≠p kho ${result.ma_phieu} th√†nh c√¥ng!`);
                    document.getElementById('phieuNhapForm').reset();
                    document.getElementById('pnkChiTiet').innerHTML = '';
                    loadPhieuNhap();
                    loadItems();
                } else {
                    showAlert('‚ùå L·ªói khi nh·∫≠p kho!', 'error');
                }
            } catch (error) {
                showAlert('‚ùå L·ªói khi nh·∫≠p kho!', 'error');
            }
        }

        async function loadPhieuNhap() {
            try {
                const response = await fetch(`${API_URL}/phieu-nhap-kho`);
                const phieus = await response.json();
                
                document.getElementById('phieuNhapTable').innerHTML = phieus.map(p => 
                    `<tr>
                        <td><strong>${p.ma_phieu}</strong></td>
                        <td>${new Date(p.ngay_nhap).toLocaleDateString('vi-VN')}</td>
                        <td>${p.nguoi_nhap}</td>
                        <td>${p.nha_cung_cap}</td>
                        <td>${p.so_hoa_don || '-'}</td>
                        <td>
                            <button class="btn btn-danger btn-small" onclick="deletePhieuNhap(${p.id}, '${p.ma_phieu}')" title="X√≥a phi·∫øu v√† ho√†n t√°c t·ªìn kho">üóëÔ∏è X√≥a</button>
                        </td>
                    </tr>`
                ).join('') || '<tr><td colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            } catch (error) {
                showAlert('L·ªói khi t·∫£i phi·∫øu nh·∫≠p!', 'error');
            }
        }

        async function deletePhieuNhap(id, maPhieu) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phi·∫øu nh·∫≠p ${maPhieu}?\n\nL∆∞u √Ω: S·ªë l∆∞·ª£ng t·ªìn kho s·∫Ω b·ªã tr·ª´ ƒëi!\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/phieu-nhap-kho/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('ƒê√£ x√≥a phi·∫øu nh·∫≠p kho v√† ho√†n t√°c t·ªìn kho th√†nh c√¥ng!', 'success');
                    loadPhieuNhap();
                    loadItems(); // Reload items to update stock
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'L·ªói khi x√≥a phi·∫øu nh·∫≠p kho!', 'error');
                }
            } catch (error) {
                showAlert('L·ªói k·∫øt n·ªëi khi x√≥a phi·∫øu nh·∫≠p kho!', 'error');
            }
        }

        async function loadApprovedPDN() {
            try {
                const response = await fetch(`${API_URL}/phieu-de-nghi`);
                const phieus = await response.json();
                const approved = phieus.filter(p => p.trang_thai === 'ƒê√£ duy·ªát');
                
                const select = document.getElementById('pnkFromPDN');
                select.innerHTML = '<option value="">-- Nh·∫≠p th·ªß c√¥ng --</option>' + 
                    approved.map(p => `<option value="${p.id}">${p.ma_phieu} - ${p.nguoi_de_nghi} (${new Date(p.ngay_de_nghi).toLocaleDateString('vi-VN')})</option>`).join('');
            } catch (error) {
                console.error('L·ªói khi t·∫£i phi·∫øu ƒë√£ duy·ªát:', error);
            }
        }

        async function loadDuyetDeNghi() {
            try {
                const response = await fetch(`${API_URL}/phieu-de-nghi`);
                const phieus = await response.json();
                const pending = phieus.filter(p => p.trang_thai === 'Ch·ªù duy·ªát');
                
                document.getElementById('duyetDeNghiTable').innerHTML = pending.map(p => 
                    `<tr>
                        <td><strong>${p.ma_phieu}</strong></td>
                        <td>${new Date(p.ngay_de_nghi).toLocaleDateString('vi-VN')}</td>
                        <td>${p.nguoi_de_nghi}</td>
                        <td>${p.phong_ban}</td>
                        <td>${p.ly_do}</td>
                        <td><span class="badge badge-warning">${p.trang_thai}</span></td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-primary btn-small" onclick="xemChiTietPDN(${p.id})" title="Xem chi ti·∫øt">üëÅÔ∏è</button>
                            <button class="btn btn-info btn-small" onclick="suaPhieuDeNghi(${p.id})" title="S·ª≠a phi·∫øu">‚úèÔ∏è</button>
                            <button class="btn btn-success btn-small" onclick="pheDuyetPhieu(${p.id}, 'ƒê√£ duy·ªát')" title="Duy·ªát phi·∫øu">‚úÖ</button>
                            <button class="btn btn-danger btn-small" onclick="pheDuyetPhieu(${p.id}, 'T·ª´ ch·ªëi')" title="T·ª´ ch·ªëi">‚ùå</button>
                        </td>
                    </tr>`
                ).join('') || '<tr><td colspan="7">Kh√¥ng c√≥ phi·∫øu ch·ªù duy·ªát</td></tr>';
            } catch (error) {
                showAlert('L·ªói khi t·∫£i phi·∫øu ch·ªù duy·ªát!', 'error');
            }
        }

        async function xemChiTietPDN(id) {
            try {
                // Load items if not yet loaded
                if (allItems.length === 0) {
                    const itemsResponse = await fetch(`${API_URL}/items`);
                    allItems = await itemsResponse.json();
                }
                
                const response = await fetch(`${API_URL}/phieu-de-nghi/${id}`);
                if (response.ok) {
                    const phieu = await response.json();
                    
                    // Hi·ªÉn th·ªã th√¥ng tin phi·∫øu
                    document.getElementById('pdnMaPhieu').textContent = phieu.ma_phieu;
                    const date = new Date(phieu.ngay_de_nghi);
                    document.getElementById('pdnNgay').textContent = date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
                    document.getElementById('pdnNguoi').textContent = phieu.nguoi_de_nghi;
                    document.getElementById('pdnPhongBan').textContent = phieu.phong_ban;
                    document.getElementById('pdnLyDo').textContent = phieu.ly_do;
                    
                    // Hi·ªÉn th·ªã tr·∫°ng th√°i v·ªõi badge
                    let badgeClass = phieu.trang_thai === 'ƒê√£ duy·ªát' ? 'badge-success' : 
                                     phieu.trang_thai === 'T·ª´ ch·ªëi' ? 'badge-danger' : 'badge-warning';
                    document.getElementById('pdnTrangThai').innerHTML = `<span class="badge ${badgeClass}">${phieu.trang_thai}</span>`;
                    
                    // Hi·ªÉn th·ªã chi ti·∫øt v·ªõi t√≠nh t·ªïng ti·ªÅn
                    let tongTien = 0;
                    const chiTietHTML = phieu.chi_tiet.map(ct => {
                        const item = allItems.find(i => i.id === ct.item_id);
                        const thanhTien = ct.so_luong * (ct.don_gia_du_kien || 0);
                        tongTien += thanhTien;
                        return `<tr>
                            <td><strong>${item?.code || '-'}</strong></td>
                            <td>${item?.name || '-'}</td>
                            <td>${item?.unit || '-'}</td>
                            <td>${item?.quy_cach || '-'}</td>
                            <td style="text-align: center;"><strong>${ct.so_luong}</strong></td>
                            <td style="text-align: right;">${new Intl.NumberFormat('vi-VN').format(ct.don_gia_du_kien || 0)}ƒë</td>
                            <td style="text-align: right;"><strong>${new Intl.NumberFormat('vi-VN').format(thanhTien)}ƒë</strong></td>
                            <td>${ct.ghi_chu || '-'}</td>
                        </tr>`;
                    }).join('');
                    
                    document.getElementById('pdnChiTietTable').innerHTML = chiTietHTML;
                    document.getElementById('pdnTongTien').textContent = new Intl.NumberFormat('vi-VN').format(tongTien) + 'ƒë';
                    
                    // Hi·ªÉn th·ªã modal
                    document.getElementById('pdnModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error viewing PDN:', error);
                showAlert('‚ùå L·ªói khi xem chi ti·∫øt!', 'error');
            }
        }

        function closePDNModal() {
            document.getElementById('pdnModal').style.display = 'none';
        }

        // S·ª≠a phi·∫øu ƒë·ªÅ ngh·ªã
        let editPdnCounter = 0;
        async function suaPhieuDeNghi(id) {
            try {
                // Load items if not yet loaded
                if (allItems.length === 0) {
                    const itemsResponse = await fetch(`${API_URL}/items`);
                    allItems = await itemsResponse.json();
                }
                
                const response = await fetch(`${API_URL}/phieu-de-nghi/${id}`);
                if (response.ok) {
                    const phieu = await response.json();
                    
                    // ƒêi·ªÅn th√¥ng tin phi·∫øu
                    document.getElementById('editPDNId').value = phieu.id;
                    document.getElementById('editPDNMaPhieu').value = phieu.ma_phieu;
                    document.getElementById('editPDNNguoi').value = phieu.nguoi_de_nghi;
                    document.getElementById('editPDNPhongBan').value = phieu.phong_ban;
                    document.getElementById('editPDNLyDo').value = phieu.ly_do;
                    
                    // ƒêi·ªÅn chi ti·∫øt
                    const chiTietContainer = document.getElementById('editPDNChiTiet');
                    chiTietContainer.innerHTML = '';
                    editPdnCounter = 0;
                    
                    phieu.chi_tiet.forEach(ct => {
                        const tr = document.createElement('tr');
                        tr.id = `edit-pdn-item-${editPdnCounter}`;
                        tr.innerHTML = `
                            <td>
                                <select class="edit-pdn-item" required onchange="updateEditPDNItemInfo(${editPdnCounter})" style="width: 100%;">
                                    <option value="">-- Ch·ªçn v·∫≠t t∆∞ --</option>
                                    ${allItems.map(item => `<option value="${item.id}" ${item.id === ct.item_id ? 'selected' : ''} data-unit="${item.unit || ''}" data-quycach="${item.quy_cach || ''}" data-price="${item.price}">${item.name}</option>`).join('')}
                                </select>
                            </td>
                            <td><input type="text" class="edit-pdn-unit" readonly style="background: #f0f0f0; width: 100%;"></td>
                            <td><input type="text" class="edit-pdn-quycach" readonly style="background: #f0f0f0; width: 100%;"></td>
                            <td><input type="number" class="edit-pdn-soluong" required min="1" value="${ct.so_luong}" style="width: 100%;"></td>
                            <td><input type="number" class="edit-pdn-dongia" min="0" step="0.01" value="${ct.don_gia_du_kien || 0}" style="width: 100%;"></td>
                            <td><input type="text" class="edit-pdn-ghichu" value="${ct.ghi_chu || ''}" style="width: 100%;"></td>
                            <td style="text-align: center;">
                                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.parentElement.remove()">üóëÔ∏è</button>
                            </td>
                        `;
                        chiTietContainer.appendChild(tr);
                        updateEditPDNItemInfo(editPdnCounter);
                        editPdnCounter++;
                    });
                    
                    // Hi·ªÉn th·ªã modal
                    document.getElementById('editPDNModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading PDN for edit:', error);
                showAlert('‚ùå L·ªói khi t·∫£i phi·∫øu ƒë·ªÅ ngh·ªã!', 'error');
            }
        }

        function addEditPDNItem() {
            const tr = document.createElement('tr');
            tr.id = `edit-pdn-item-${editPdnCounter}`;
            tr.innerHTML = `
                <td>
                    <select class="edit-pdn-item" required onchange="updateEditPDNItemInfo(${editPdnCounter})" style="width: 100%;">
                        <option value="">-- Ch·ªçn v·∫≠t t∆∞ --</option>
                        ${allItems.map(item => `<option value="${item.id}" data-unit="${item.unit || ''}" data-quycach="${item.quy_cach || ''}" data-price="${item.price}">${item.name}</option>`).join('')}
                    </select>
                </td>
                <td><input type="text" class="edit-pdn-unit" readonly style="background: #f0f0f0; width: 100%;"></td>
                <td><input type="text" class="edit-pdn-quycach" readonly style="background: #f0f0f0; width: 100%;"></td>
                <td><input type="number" class="edit-pdn-soluong" required min="1" style="width: 100%;"></td>
                <td><input type="number" class="edit-pdn-dongia" min="0" step="0.01" style="width: 100%;"></td>
                <td><input type="text" class="edit-pdn-ghichu" style="width: 100%;"></td>
                <td style="text-align: center;">
                    <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.parentElement.remove()">üóëÔ∏è</button>
                </td>
            `;
            document.getElementById('editPDNChiTiet').appendChild(tr);
            editPdnCounter++;
        }

        function updateEditPDNItemInfo(index) {
            const container = document.getElementById(`edit-pdn-item-${index}`);
            if (!container) return;
            
            const select = container.querySelector('.edit-pdn-item');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const unit = selectedOption.getAttribute('data-unit') || '-';
                const quycach = selectedOption.getAttribute('data-quycach') || '-';
                const price = selectedOption.getAttribute('data-price') || '0';
                
                container.querySelector('.edit-pdn-unit').value = unit;
                container.querySelector('.edit-pdn-quycach').value = quycach;
                container.querySelector('.edit-pdn-dongia').value = price;
            } else {
                container.querySelector('.edit-pdn-unit').value = '';
                container.querySelector('.edit-pdn-quycach').value = '';
                container.querySelector('.edit-pdn-dongia').value = '';
            }
        }

        async function updatePhieuDeNghi(e) {
            e.preventDefault();
            const id = document.getElementById('editPDNId').value;
            const chiTiet = [];
            
            document.querySelectorAll('#editPDNChiTiet tr').forEach(row => {
                const donGia = parseFloat(row.querySelector('.edit-pdn-dongia').value);
                chiTiet.push({
                    item_id: parseInt(row.querySelector('.edit-pdn-item').value),
                    so_luong: parseInt(row.querySelector('.edit-pdn-soluong').value),
                    don_gia_du_kien: donGia > 0 ? donGia : 0,
                    ghi_chu: row.querySelector('.edit-pdn-ghichu').value || null
                });
            });

            if (chiTiet.length === 0) {
                showAlert('‚ùå Vui l√≤ng th√™m √≠t nh·∫•t 1 v·∫≠t t∆∞!', 'error');
                return;
            }

            const data = {
                nguoi_de_nghi: document.getElementById('editPDNNguoi').value,
                phong_ban: document.getElementById('editPDNPhongBan').value,
                ly_do: document.getElementById('editPDNLyDo').value,
                chi_tiet: chiTiet
            };

            try {
                const response = await fetch(`${API_URL}/phieu-de-nghi/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t phi·∫øu ƒë·ªÅ ngh·ªã!', 'success');
                    closeEditPDNModal();
                    loadPhieuDeNghi();
                    loadDuyetDeNghi();
                } else {
                    const error = await response.json();
                    showAlert(error.detail || '‚ùå L·ªói khi c·∫≠p nh·∫≠t!', 'error');
                }
            } catch (error) {
                showAlert('‚ùå L·ªói k·∫øt n·ªëi!', 'error');
            }
        }

        function closeEditPDNModal() {
            document.getElementById('editPDNModal').style.display = 'none';
        }

        async function pheDuyetPhieu(id, trangThai) {
            const nguoiDuyet = prompt(`Nh·∫≠p t√™n ng∆∞·ªùi ${trangThai === 'ƒê√£ duy·ªát' ? 'duy·ªát' : 't·ª´ ch·ªëi'}:`);
            if (!nguoiDuyet) return;
            
            const ghiChu = prompt('Ghi ch√∫ (t√πy ch·ªçn):') || '';
            
            try {
                const response = await fetch(`${API_URL}/phieu-de-nghi/${id}/phe-duyet`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        trang_thai: trangThai,
                        nguoi_duyet: nguoiDuyet,
                        ghi_chu_duyet: ghiChu
                    })
                });
                if (response.ok) {
                    showAlert(`‚úÖ ${trangThai} phi·∫øu th√†nh c√¥ng!`);
                    loadDuyetDeNghi();
                } else {
                    const error = await response.json();
                    console.error('Approval error:', error);
                    showAlert(`‚ùå L·ªói: ${error.detail || 'Kh√¥ng th·ªÉ ph√™ duy·ªát'}`, 'error');
                }
            } catch (error) {
                console.error('Approval exception:', error);
                showAlert('‚ùå L·ªói khi ph√™ duy·ªát!', 'error');
            }
        }

        // Phi·∫øu xu·∫•t kho functions
        let pxkCounter = 0;
        function addPXKItem() {
            const div = document.createElement('div');
            div.className = 'chi-tiet-item';
            div.id = `pxk-item-${pxkCounter}`;
            div.innerHTML = `
                <select class="pxk-item" required onchange="updatePXKItemInfo(${pxkCounter})">
                    <option value="">-- Ch·ªçn v·∫≠t t∆∞ --</option>
                    ${allItems.map(item => `<option value="${item.id}" data-unit="${item.unit || ''}" data-quycach="${item.quy_cach || ''}" data-price="${item.price}">${item.name} (T·ªìn: ${item.current_stock})</option>`).join('')}
                </select>
                <input type="text" class="pxk-unit" placeholder="ƒêVT" readonly style="background: #f0f0f0; width: 80px;">
                <input type="text" class="pxk-quycach" placeholder="Quy c√°ch" readonly style="background: #f0f0f0; width: 120px;">
                <input type="number" class="pxk-soluong" placeholder="S·ªë l∆∞·ª£ng" required min="1">
                <input type="number" class="pxk-dongia" placeholder="ƒê∆°n gi√°" required min="0" step="0.01">
                <input type="text" class="pxk-ghichu" placeholder="Ghi ch√∫">
                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            document.getElementById('pxkChiTiet').appendChild(div);
            pxkCounter++;
        }

        function updatePXKItemInfo(index) {
            const container = document.getElementById(`pxk-item-${index}`);
            if (!container) return;
            
            const select = container.querySelector('.pxk-item');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const unit = selectedOption.getAttribute('data-unit') || '-';
                const quycach = selectedOption.getAttribute('data-quycach') || '-';
                const price = selectedOption.getAttribute('data-price') || '0';
                
                container.querySelector('.pxk-unit').value = unit;
                container.querySelector('.pxk-quycach').value = quycach;
                container.querySelector('.pxk-dongia').value = price;
            } else {
                container.querySelector('.pxk-unit').value = '';
                container.querySelector('.pxk-quycach').value = '';
                container.querySelector('.pxk-dongia').value = '';
            }
        }

        async function createPhieuXuat(e) {
            e.preventDefault();
            const chiTiet = [];
            document.querySelectorAll('#pxkChiTiet .chi-tiet-item').forEach(item => {
                chiTiet.push({
                    item_id: parseInt(item.querySelector('.pxk-item').value),
                    so_luong: parseInt(item.querySelector('.pxk-soluong').value),
                    don_gia: parseFloat(item.querySelector('.pxk-dongia').value),
                    ghi_chu: item.querySelector('.pxk-ghichu').value || null
                });
            });

            if (chiTiet.length === 0) {
                showAlert('‚ùå Vui l√≤ng th√™m √≠t nh·∫•t 1 v·∫≠t t∆∞!', 'error');
                return;
            }

            const data = {
                nguoi_xuat: document.getElementById('pxkNguoiXuat').value,
                nguoi_nhan: document.getElementById('pxkNguoiNhan').value,
                phong_ban: document.getElementById('pxkPhongBan').value,
                loai_xuat: document.getElementById('pxkLoaiXuat').value,
                ly_do: document.getElementById('pxkLyDo').value,
                ghi_chu: null,
                chi_tiet: chiTiet
            };

            try {
                const response = await fetch(`${API_URL}/phieu-xuat-kho`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    const result = await response.json();
                    showAlert(`‚úÖ Xu·∫•t kho ${result.ma_phieu} th√†nh c√¥ng!`);
                    document.getElementById('phieuXuatForm').reset();
                    document.getElementById('pxkChiTiet').innerHTML = '';
                    loadPhieuXuat();
                    loadItems();
                } else {
                    const error = await response.json();
                    showAlert(`‚ùå ${error.detail}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå L·ªói khi xu·∫•t kho!', 'error');
            }
        }

        async function loadPhieuXuat() {
            try {
                const response = await fetch(`${API_URL}/phieu-xuat-kho`);
                const phieus = await response.json();
                
                document.getElementById('phieuXuatTable').innerHTML = phieus.map(p => 
                    `<tr>
                        <td><strong>${p.ma_phieu}</strong></td>
                        <td>${new Date(p.ngay_xuat).toLocaleDateString('vi-VN')}</td>
                        <td>${p.nguoi_xuat}</td>
                        <td>${p.nguoi_nhan}</td>
                        <td><span class="badge badge-info">${p.loai_xuat}</span></td>
                        <td>
                            <button class="btn btn-danger btn-small" onclick="deletePhieuXuat(${p.id}, '${p.ma_phieu}')" title="X√≥a phi·∫øu v√† ho√†n t√°c t·ªìn kho">üóëÔ∏è X√≥a</button>
                        </td>
                    </tr>`
                ).join('') || '<tr><td colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            } catch (error) {
                showAlert('L·ªói khi t·∫£i phi·∫øu xu·∫•t!', 'error');
            }
        }

        async function deletePhieuXuat(id, maPhieu) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phi·∫øu xu·∫•t ${maPhieu}?\n\nL∆∞u √Ω: S·ªë l∆∞·ª£ng t·ªìn kho s·∫Ω ƒë∆∞·ª£c c·ªông l·∫°i!\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/phieu-xuat-kho/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('ƒê√£ x√≥a phi·∫øu xu·∫•t kho v√† ho√†n t√°c t·ªìn kho th√†nh c√¥ng!', 'success');
                    loadPhieuXuat();
                    loadItems(); // Reload items to update stock
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'L·ªói khi x√≥a phi·∫øu xu·∫•t kho!', 'error');
                }
            } catch (error) {
                showAlert('L·ªói k·∫øt n·ªëi khi x√≥a phi·∫øu xu·∫•t kho!', 'error');
            }
        }

        // T·ªìn kho functions
        async function loadTonKho() {
            try {
                const response = await fetch(`${API_URL}/ton-kho`);
                const items = await response.json();
                
                document.getElementById('tonKhoTable').innerHTML = items.map(item => {
                    let badgeClass = item.status === 'D∆∞·ªõi m·ª©c t·ªëi thi·ªÉu' ? 'badge-danger' :
                                     item.status === 'V∆∞·ª£t m·ª©c t·ªëi ƒëa' ? 'badge-warning' : 'badge-success';
                    return `<tr>
                        <td><strong>${item.code}</strong></td>
                        <td>${item.name}</td>
                        <td>${item.unit || '-'}</td>
                        <td><strong>${item.current_stock}</strong></td>
                        <td>${item.min_stock}</td>
                        <td>${item.max_stock}</td>
                        <td><span class="badge ${badgeClass}">${item.status}</span></td>
                    </tr>`;
                }).join('') || '<tr><td colspan="7">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            } catch (error) {
                showAlert('L·ªói khi t·∫£i t·ªìn kho!', 'error');
            }
        }

        // Th·∫ª kho functions
        function populateTheKhoSelect() {
            const select = document.getElementById('theKhoItemSelect');
            select.innerHTML = '<option value="">-- Ch·ªçn v·∫≠t t∆∞ --</option>' +
                allItems.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
        }

        async function loadTheKho() {
            const itemId = document.getElementById('theKhoItemSelect').value;
            if (!itemId) {
                document.getElementById('theKhoContent').innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/the-kho/${itemId}`);
                const data = await response.json();
                
                const html = `
                    <div class="form-section">
                        <h3>Th√¥ng tin v·∫≠t t∆∞</h3>
                        <p><strong>M√£:</strong> ${data.item.code} | <strong>T√™n:</strong> ${data.item.name} | 
                        <strong>ƒêVT:</strong> ${data.item.unit || '-'} | <strong>T·ªìn hi·ªán t·∫°i:</strong> ${data.item.current_stock}</p>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr><th>Ng√†y</th><th>Lo·∫°i</th><th>M√£ phi·∫øu</th><th>Nh·∫≠p</th><th>Xu·∫•t</th><th>T·ªìn</th><th>ƒê∆°n gi√°</th></tr>
                            </thead>
                            <tbody>
                                ${data.the_kho.map(tk => `
                                    <tr>
                                        <td>${new Date(tk.ngay_thang).toLocaleDateString('vi-VN')}</td>
                                        <td><span class="badge ${tk.loai_phieu === 'Nh·∫≠p' ? 'badge-success' : 'badge-warning'}">${tk.loai_phieu}</span></td>
                                        <td><strong>${tk.ma_phieu}</strong></td>
                                        <td>${tk.so_luong_nhap || '-'}</td>
                                        <td>${tk.so_luong_xuat || '-'}</td>
                                        <td><strong>${tk.ton_kho}</strong></td>
                                        <td>${tk.don_gia.toLocaleString()}</td>
                                    </tr>
                                `).join('') || '<tr><td colspan="7">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('theKhoContent').innerHTML = html;
            } catch (error) {
                showAlert('L·ªói khi t·∫£i th·∫ª kho!', 'error');
            }
        }

        // Initialize
        window.onload = async () => {
            await checkConnection();
            loadCategories();
            setInterval(checkConnection, 30000);
        };
    </script>
</body>
</html>
