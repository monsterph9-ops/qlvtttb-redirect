<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Hệ thống Quản lý Vật tư</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        #loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #status {
            font-size: 16px;
            margin: 10px 0;
            text-align: center;
            padding: 0 20px;
        }
        #appFrame {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        #appFrame.visible {
            display: block;
        }
        #error {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 10000;
        }
        #error.visible {
            display: block;
        }
        #error h2 {
            color: #e74c3c;
            margin-bottom: 20px;
        }
        #error button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        #error button:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <h2>Đang tải hệ thống...</h2>
        <div id="status">Vui lòng đợi</div>
    </div>
    
    <iframe id="appFrame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals allow-downloads"></iframe>
    
    <div id="error">
        <h2>❌ Không thể kết nối</h2>
        <p id="errorMessage"></p>
        <button onclick="retryLoad()">Thử lại</button>
    </div>
    
    <script>
        // Dùng GitHub API thay vì raw URL để tránh cache
        // Đổi sang proxy server nội bộ để tránh cache và rate limit
        const PROXY_API = 'https://script.google.com/macros/s/AKfycbyOYIcoV4Mw85R_rq9IInvB1nLTEmAGOtzaNLPfz9-5q_FBdr25Cr7JV3lue-0TmW5f/exec';
        let tunnelUrl = '';
        let checkAttempts = 0;
        const MAX_ATTEMPTS_PER_ROUND = 60;
        let currentRound = 0;
        const MAX_ROUNDS = 3;
        let waitingFor10Min = false;
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('[IFRAME]', message);
        }
        
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').classList.add('visible');
            document.getElementById('loading').classList.add('hidden');
        }
        
        function retryLoad() {
            document.getElementById('error').classList.remove('visible');
            document.getElementById('loading').classList.remove('hidden');
            currentRound = 0;
            checkAttempts = 0;
            waitingFor10Min = false;
            loadURL();
        }
        
        async function loadURL() {
            try {
                updateStatus('Đang tải URL từ proxy server...');
                const response = await fetch(PROXY_API + '?t=' + Date.now(), { cache: 'no-store' });
                const data = await response.json();
                tunnelUrl = (data.url || '').trim();
                if (!tunnelUrl || !tunnelUrl.startsWith('http')) {
                    updateStatus('❌ URL không hợp lệ. Đang thử lại sau 3 giây...');
                    setTimeout(loadURL, 3000);
                    return;
                }
                console.log('[URL]', tunnelUrl);
                // Bắt đầu kiểm tra và load iframe
                currentRound = 1;
                checkAttempts = 0;
                checkAndLoadIframe();
            } catch (error) {
                console.error('[ERROR]', error);
                updateStatus('❌ Lỗi kết nối đến proxy server. Đang thử lại sau 5 giây...');
                setTimeout(loadURL, 5000);
            }
        }
        
        function checkAndLoadIframe() {
            if (waitingFor10Min) return;
            
            checkAttempts++;
            
            if (checkAttempts > MAX_ATTEMPTS_PER_ROUND) {
                currentRound++;
                
                if (currentRound > MAX_ROUNDS) {
                    showError('Server đã bị tắt. Vui lòng liên hệ với Admin để khởi động server.');
                    return;
                }
                
                waitingFor10Min = true;
                checkAttempts = 0;
                updateStatus(`⏳ Server đang tắt. Thử lại sau 10 phút... (Đợt ${currentRound}/${MAX_ROUNDS})`);
                
                setTimeout(() => {
                    waitingFor10Min = false;
                    checkAndLoadIframe();
                }, 10 * 60 * 1000);
                return;
            }
            
            updateStatus(`Đang kiểm tra server... (Đợt ${currentRound}/${MAX_ROUNDS}, Lần ${checkAttempts}/${MAX_ATTEMPTS_PER_ROUND})`);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            
            fetch(tunnelUrl + '/health', {
                method: 'GET',
                signal: controller.signal,
                cache: 'no-store'
            })
            .then(response => {
                clearTimeout(timeoutId);
                console.log('[CHECK] Status:', response.status);
                
                if (response.status === 200) {
                    updateStatus('✅ Server sẵn sàng! Đang tải ứng dụng...');
                    loadAppInIframe();
                } else {
                    console.log('[CHECK] Status:', response.status, '- thử lại...');
                    setTimeout(checkAndLoadIframe, 3000);
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.log('[CHECK] Lỗi:', error.message);
                setTimeout(checkAndLoadIframe, 3000);
            });
        }
        
        function loadAppInIframe() {
            const iframe = document.getElementById('appFrame');
            
            iframe.onload = () => {
                console.log('[IFRAME] App loaded successfully');
                document.getElementById('loading').classList.add('hidden');
                iframe.classList.add('visible');
            };
            
            iframe.onerror = () => {
                console.error('[IFRAME] Failed to load');
                showError('Không thể tải ứng dụng. Vui lòng thử lại.');
            };
            
            // Load app trong iframe
            iframe.src = tunnelUrl;
        }
        
        // Bắt đầu
        loadURL();

        // Lắng nghe postMessage từ iframe để reload khi app báo lỗi
        window.addEventListener('message', function(event) {
            // Có thể kiểm tra origin nếu muốn an toàn hơn
            if (event.data && event.data.type === 'reload') {
                console.log('[PARENT] Nhận yêu cầu reload từ iframe, thực hiện reload...');
                window.location.reload();
            }
        });
    </script>
</body>
</html>
